<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simulador Electricista: Instalaci√≥n Correcta</title>
    <style>
        :root {
            --bg-color: #e0e5ec;
            --panel-bg: #2d3436;
            --wire-phase: #c0392b;   /* Marr√≥n/Rojo */
            --wire-neutral: #2980b9; /* Celeste */
            --wire-earth: #27ae60;   /* Verde/Amarillo */
            --wire-return: #2c3e50;  /* Negro/Gris */
            --shadow-light: 9px 9px 16px rgb(163,177,198,0.6), -9px -9px 16px rgba(255,255,255, 0.5);
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh; user-select: none;
        }

        /* --- HEADER --- */
        header {
            background: var(--panel-bg); color: white; padding: 15px 25px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 20;
        }

        .header-title h1 { margin: 0; font-size: 1.2rem; }
        .header-title small { color: #b2bec3; font-size: 0.8rem; }

        .toolbar { display: flex; gap: 15px; }

        .btn {
            background: #636e72; color: white; border: none; padding: 10px 20px;
            border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        .btn:hover { background: #b2bec3; color: #2d3436; transform: translateY(-2px); }
        
        .btn-reset { background: #d63031; }
        .btn-help { background: #0984e3; }
        
        .tool-active { 
            background: #00b894 !important; color: #2d3436 !important; 
            box-shadow: 0 0 10px #00b894;
        }

        /* --- TABLERO DE JUEGO --- */
        #game-board {
            position: relative; flex-grow: 1;
            background-image: radial-gradient(#a4b0be 1px, transparent 1px);
            background-size: 25px 25px;
            cursor: default;
        }

        #wire-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* --- COMPONENTES --- */
        .component {
            position: absolute; background: #dfe6e9; border: 1px solid #b2bec3;
            box-shadow: 8px 8px 16px rgba(0,0,0,0.15); z-index: 2; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* Tablero */
        .comp-board { width: 120px; height: 180px; background: #2d3436; color: white; left: 5%; top: 15%; }
        .breaker {
            width: 60px; height: 40px; background: #e17055; margin-bottom: 20px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;
            box-shadow: inset 0 -4px rgba(0,0,0,0.3); transition: 0.2s; border: 2px solid #a84732;
        }
        .breaker.on { background: #00b894; border-color: #008f72; transform: translateY(2px); box-shadow: inset 0 2px rgba(0,0,0,0.3); }
        .breaker::after { content: 'OFF'; color: white; font-size: 0.8rem; }
        .breaker.on::after { content: 'ON'; }

        /* Tecla */
        .comp-switch { width: 90px; height: 120px; left: 40%; top: 55%; background: #f5f6fa; }
        .switch-housing { width: 40px; height: 70px; background: white; border: 1px solid #dcdde1; border-radius: 2px; cursor: pointer; position: relative; }
        .switch-btn { 
            width: 100%; height: 50%; background: #f1f2f6; border-bottom: 1px solid #ccc; 
            transition: 0.1s; position: absolute; top:0; 
        }
        .switch-btn.active { top: 50%; border-bottom: none; border-top: 1px solid #ccc; background: #eccc68; }

        /* L√°mpara */
        .comp-lamp { width: 100px; height: 100px; border-radius: 50%; left: 75%; top: 25%; background: #fff; border: 4px solid #b2bec3; }
        .bulb { width: 100%; height: 100%; border-radius: 50%; background: #b2bec3; opacity: 0.3; transition: 0.3s; }
        .bulb.on { background: #f1c40f; opacity: 1; box-shadow: 0 0 80px #f1c40f; }

        /* TERMINALES */
        .terminal {
            width: 22px; height: 22px; background: #b2bec3; border: 3px solid #636e72; border-radius: 50%;
            position: absolute; cursor: pointer; z-index: 10; transition: transform 0.2s;
        }
        .terminal:hover { background: #fdcb6e; transform: scale(1.2); border-color: white; }
        .terminal.selected { background: #00b894; border-color: #fff; box-shadow: 0 0 10px #00b894; transform: scale(1.3); }
        
        .lbl { position: absolute; font-size: 10px; font-weight: bold; pointer-events: none; color: #2d3436; white-space: nowrap; }
        .lbl-white { color: white; }

        /* CABLES */
        path.wire { 
            fill: none; 
            stroke-width: 6; 
            stroke-linecap: round; 
            stroke-linejoin: round;
            cursor: pointer; 
            transition: stroke-width 0.2s, stroke 0.2s;
            filter: drop-shadow(2px 4px 2px rgba(0,0,0,0.3)); /* Sombra realista */
        }
        path.wire:hover { stroke-width: 10; filter: drop-shadow(3px 6px 3px rgba(0,0,0,0.4)); }
        
        /* Animaci√≥n Error */
        .error-shake { animation: shake 0.4s ease-in-out; background: #e74c3c !important; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* TOAST & MODAL */
        #toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #2d3436; color: white; padding: 12px 30px; border-radius: 50px;
            font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 5000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        #win-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 6000; display: none;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .win-card {
            background: white; padding: 40px; border-radius: 15px; text-align: center;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from{transform: scale(0.5); opacity:0;} to{transform: scale(1); opacity:1;} }

        /* MEN√ö CONTEXTUAL (Borrar) */
        #ctx-menu {
            position: absolute; display: none; background: white; padding: 5px;
            border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 4000;
        }
        .ctx-btn {
            background: #d63031; color: white; border: none; padding: 8px 15px;
            border-radius: 4px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px;
        }
        .ctx-btn:hover { background: #c0392b; }

    </style>
</head>
<body>

    <!-- MEN√ö CONTEXTUAL -->
    <div id="ctx-menu">
        <button class="ctx-btn" onclick="game.deleteSelectedWire()">üóë Quitar Cable</button>
    </div>

    <!-- MODAL VICTORIA -->
    <div id="win-modal">
        <div class="win-card">
            <h1 style="color:#00b894; margin-bottom:10px;">¬°Excelente Trabajo!</h1>
            <p style="color:#636e72; margin-bottom:20px;">La instalaci√≥n es segura y la luz funciona.</p>
            <button class="btn btn-help" onclick="game.nextLevel()">Siguiente Nivel ‚û°</button>
        </div>
    </div>

    <!-- HEADER -->
    <header>
        <div class="header-title">
            <h1>Simulador Electricista</h1>
            <small>Nivel <span id="lvl-num">1</span>: Instalaci√≥n B√°sica</small>
        </div>
        <div class="toolbar">
            <div class="btn tool-active" id="tool-hand">üñê Conectar / Mano</div>
            <button class="btn btn-help" onclick="alert('Instrucciones:\n1. Click en un terminal para empezar cable.\n2. Click en otro terminal para conectar.\n3. Click derecho en un cable para borrar.\n4. La t√©rmica debe estar OFF para trabajar.')">‚ùì Ayuda</button>
            <button class="btn btn-reset" onclick="game.resetLevel()">Reiniciar</button>
        </div>
    </header>

    <!-- TABLERO -->
    <div id="game-board">
        <svg id="wire-layer"></svg>

        <!-- 1. TABLERO GENERAL -->
        <div class="component comp-board">
            <div style="font-weight:bold; margin-bottom:10px;">TABLERO</div>
            <div id="breaker" class="breaker" onclick="game.togglePower()"></div>
            
            <div style="position:relative; width:100%; height:100px;">
                <!-- Fase -->
                <span class="lbl lbl-white" style="top:12px; right:35px;">L</span>
                <div class="terminal" id="t-src-L" style="top:10px; right:-11px; background:#c0392b;"></div>
                
                <!-- Neutro -->
                <span class="lbl lbl-white" style="top:42px; right:35px;">N</span>
                <div class="terminal" id="t-src-N" style="top:40px; right:-11px; background:#2980b9;"></div>
                
                <!-- Tierra -->
                <span class="lbl lbl-white" style="top:72px; right:35px;">T</span>
                <div class="terminal" id="t-src-E" style="top:70px; right:-11px; background:#27ae60;"></div>
            </div>
        </div>

        <!-- 2. INTERRUPTOR -->
        <div class="component comp-switch">
            <div style="font-weight:bold; font-size:0.8rem; margin-top:5px;">TECLA</div>
            <div class="switch-housing" onclick="game.toggleSwitch()">
                <div class="switch-btn" id="sw-btn"></div>
            </div>
            
            <!-- Entrada (Fase) -->
            <div class="terminal" id="t-sw-in" style="top:30px; left:-11px;"></div>
            <span class="lbl" style="top:32px; left:15px;">L</span>
            
            <!-- Salida (Retorno) -->
            <div class="terminal" id="t-sw-out" style="top:80px; right:-11px;"></div>
            <span class="lbl" style="top:82px; right:15px;">1</span>
        </div>

        <!-- 3. L√ÅMPARA -->
        <div class="component comp-lamp">
            <div class="bulb" id="bulb"></div>
            
            <!-- Retorno -->
            <div class="terminal" id="t-lmp-L" style="bottom:-5px; left:15px;"></div>
            <span class="lbl" style="bottom:18px; left:20px;">Ret</span>
            
            <!-- Neutro -->
            <div class="terminal" id="t-lmp-N" style="bottom:-5px; right:15px;"></div>
            <span class="lbl" style="bottom:18px; right:20px;">Neu</span>
            
            <!-- Tierra -->
            <div class="terminal" id="t-lmp-E" style="top:-5px; left:40px; background:#27ae60;"></div>
        </div>

        <div id="toast">Notificaci√≥n</div>
    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";

        class Simulator {
            constructor() {
                this.wires = [];
                this.powerOn = false;
                this.switchOn = false;
                this.selectedTerminal = null;
                this.wireToDelete = null;
                this.level = 1;

                this.svg = document.getElementById('wire-layer');
                this.board = document.getElementById('game-board');
                this.ctxMenu = document.getElementById('ctx-menu');

                this.initInteraction();
                this.showToast("Bienvenido. Conecta los cables correctamente.");
            }

            // --- SISTEMA DE NIVELES ---
            nextLevel() {
                this.level++;
                document.getElementById('lvl-num').textContent = this.level;
                document.getElementById('win-modal').style.display = 'none';
                this.resetLevel();
                this.showToast("Nivel " + this.level + ": ¬°A trabajar!");
            }

            resetLevel() {
                this.wires.forEach(w => w.el.remove());
                this.wires = [];
                if(this.powerOn) this.togglePower();
                this.switchOn = false;
                document.getElementById('sw-btn').classList.remove('active');
                this.selectedTerminal = null;
                this.updateTerminalsVisuals();
                this.updateCircuit();
            }

            // --- INTERACCI√ìN ---
            initInteraction() {
                // Click en Terminales
                document.querySelectorAll('.terminal').forEach(t => {
                    t.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.handleTerminalClick(t.id);
                    });
                });

                // Click derecho en cables (Context menu)
                this.svg.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    // Detectar si el click fue sobre un path.wire
                    const el = document.elementFromPoint(e.clientX, e.clientY);
                    if(el && el.classList.contains('wire')) {
                        const wire = this.wires.find(w => w.el === el);
                        if(wire) {
                            this.wireToDelete = wire;
                            this.ctxMenu.style.display = 'block';
                            this.ctxMenu.style.left = e.clientX + 'px';
                            this.ctxMenu.style.top = e.clientY + 'px';
                        }
                    }
                });

                // Cerrar men√∫ al clickear fuera
                window.addEventListener('click', () => {
                    this.ctxMenu.style.display = 'none';
                    if(this.selectedTerminal) {
                        // Cancelar selecci√≥n si clickea en el vac√≠o
                        this.selectedTerminal = null;
                        this.updateTerminalsVisuals();
                    }
                });
            }

            handleTerminalClick(id) {
                if(this.powerOn) {
                    this.showToast("‚ö†Ô∏è ¬°PELIGRO! Corta la luz antes de tocar.", "error");
                    this.playErrorSound();
                    return;
                }

                if(!this.selectedTerminal) {
                    // Seleccionar primero
                    this.selectedTerminal = id;
                    this.updateTerminalsVisuals();
                    this.playSound(400, 'sine');
                } else {
                    // Conectar con el segundo
                    if(this.selectedTerminal !== id) {
                        this.tryConnect(this.selectedTerminal, id);
                    }
                    this.selectedTerminal = null;
                    this.updateTerminalsVisuals();
                }
            }

            updateTerminalsVisuals() {
                document.querySelectorAll('.terminal').forEach(t => t.classList.remove('selected'));
                if(this.selectedTerminal) {
                    document.getElementById(this.selectedTerminal).classList.add('selected');
                }
            }

            // --- L√ìGICA DE CONEXI√ìN Y DIBUJO ---
            tryConnect(u, v) {
                // Evitar duplicados
                if(this.wires.find(w => (w.u===u && w.v===v) || (w.u===v && w.v===u))) {
                    this.showToast("Ya existe una conexi√≥n ah√≠.");
                    return;
                }

                // VALIDACI√ìN INTELIGENTE (Permite errores pero avisa los graves)
                if(!this.validateConnection(u, v)) return;

                // Crear Cable
                const type = this.getWireType(u, v);
                const path = document.createElementNS(svgNS, 'path');
                path.classList.add('wire');
                path.setAttribute('stroke', type.color);
                this.svg.appendChild(path);

                const wireObj = { u, v, el: path, type: type.name };
                this.wires.push(wireObj);
                
                this.updateWirePath(wireObj);
                this.playSound(600, 'sine');
                this.updateCircuit();
            }

            validateConnection(u, v) {
                // Prevenir Tierra con Fase o Neutro (Corto grave inmediato en la realidad)
                const t1 = this.getTerminalType(u);
                const t2 = this.getTerminalType(v);

                // Regla b√°sica: Fase no toca Tierra ni Neutro directo sin carga
                // Aqu√≠ simplificamos: Si conectas Tierra a Fase, vibra y error.
                if((t1 === 'earth' && (t2 === 'phase' || t2 === 'neutral')) || 
                   (t2 === 'earth' && (t1 === 'phase' || t1 === 'neutral'))) {
                    this.showErrorShake(u, v);
                    this.showToast("‚ùå Error: Conexi√≥n peligrosa a Tierra.", "error");
                    this.playErrorSound();
                    return false;
                }
                
                return true;
            }

            getTerminalType(id) {
                if(id.includes('L') || id.includes('in')) return 'phase';
                if(id.includes('N')) return 'neutral';
                if(id.includes('E')) return 'earth';
                return 'return';
            }

            getWireType(u, v) {
                // Determina color
                if(u.includes('E') || v.includes('E')) return { color: 'var(--wire-earth)', name: 'tierra' };
                if(u.includes('N') || v.includes('N')) return { color: 'var(--wire-neutral)', name: 'neutro' };
                if(u.includes('src-L')) return { color: 'var(--wire-phase)', name: 'fase' };
                return { color: 'var(--wire-return)', name: 'retorno' };
            }

            updateWirePath(w) {
                const el1 = document.getElementById(w.u);
                const el2 = document.getElementById(w.v);
                const rect1 = el1.getBoundingClientRect();
                const rect2 = el2.getBoundingClientRect();
                const boardRect = this.board.getBoundingClientRect();

                const x1 = rect1.left + rect1.width/2 - boardRect.left;
                const y1 = rect1.top + rect1.height/2 - boardRect.top;
                const x2 = rect2.left + rect2.width/2 - boardRect.left;
                const y2 = rect2.top + rect2.height/2 - boardRect.top;

                // --- ALGORITMO DE CABLE EN "U" (CATENARIA SIMULADA) ---
                // Calculamos una curva B√©zier C√∫bica
                // M x1 y1 C cp1x cp1y, cp2x cp2y, x2 y2
                
                // Distancia vertical y horizontal
                const distY = Math.abs(y2 - y1);
                
                // "Sag" o ca√≠da del cable.
                // Si es el neutro a la l√°mpara, forzamos una U m√°s pronunciada.
                let sag = 60; 
                
                // Si conecta al Neutro de la l√°mpara, darle m√°s ca√≠da est√©tica
                if(w.u.includes('lmp-N') || w.v.includes('lmp-N')) {
                    sag = 100; 
                }

                // Puntos de control.
                // Para una U, los puntos de control deben estar por debajo de los terminales.
                // Tiramos los puntos de control hacia abajo verticalmente.
                
                const cp1x = x1;
                const cp1y = Math.max(y1, y2) + sag;
                
                const cp2x = x2;
                const cp2y = Math.max(y1, y2) + sag;

                const d = `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`;
                w.el.setAttribute('d', d);
            }

            deleteSelectedWire() {
                if(this.wireToDelete) {
                    if(this.powerOn) {
                        this.showToast("‚ö†Ô∏è Corta la luz para quitar cables.", "error");
                    } else {
                        this.wireToDelete.el.remove();
                        this.wires = this.wires.filter(w => w !== this.wireToDelete);
                        this.updateCircuit();
                        this.playSound(300, 'sawtooth');
                    }
                }
                this.ctxMenu.style.display = 'none';
                this.wireToDelete = null;
            }

            // --- SIMULACI√ìN EL√âCTRICA ---
            togglePower() {
                if(this.powerOn) {
                    this.powerOn = false;
                    document.getElementById('breaker').classList.remove('on');
                    this.showToast("Energ√≠a OFF");
                } else {
                    // Validar Cortocircuitos antes de subir
                    if(this.detectShortCircuit()) {
                        this.showToast("üí• ¬°CORTOCIRCUITO! Revisa las conexiones.", "error");
                        this.playErrorSound();
                        return;
                    }
                    
                    this.powerOn = true;
                    document.getElementById('breaker').classList.add('on');
                    this.showToast("‚ö° Energ√≠a ON");
                }
                this.updateCircuit();
            }

            toggleSwitch() {
                this.switchOn = !this.switchOn;
                const btn = document.getElementById('sw-btn');
                if(this.switchOn) btn.classList.add('active');
                else btn.classList.remove('active');
                this.playSound(800, 'square', 0.05); // Click sound
                this.updateCircuit();
            }

            detectShortCircuit() {
                // Grafo simple: Si Fase conecta con Neutro SIN pasar por L√°mpara.
                // En este sim b√°sico, asumimos que Fase y Neutro no deben tocarse directamente.
                const adj = this.buildAdjacency();
                // Check Fase -> Neutro directo
                return this.hasPath(adj, 't-src-L', 't-src-N');
            }

            updateCircuit() {
                const bulb = document.getElementById('bulb');
                bulb.classList.remove('on');

                if(!this.powerOn) return;

                const adj = this.buildAdjacency();
                
                // Verificar si llega FASE (L) a la l√°mpara
                // Camino: Fuente L -> Switch In -> (Si ON) -> Switch Out -> Lamp L
                let phaseAtLamp = false;
                
                // Paso 1: Fase llega al switch?
                const phaseToSwitch = this.hasPath(adj, 't-src-L', 't-sw-in');
                
                // Paso 2: Switch cerrado?
                if(phaseToSwitch && this.switchOn) {
                    // Paso 3: Switch Out llega a Lamp L?
                    const switchToLamp = this.hasPath(adj, 't-sw-out', 't-lmp-L');
                    if(switchToLamp) phaseAtLamp = true;
                }

                // Verificar si llega NEUTRO (N) a la l√°mpara
                const neutralAtLamp = this.hasPath(adj, 't-src-N', 't-lmp-N');

                // LUZ ON si tiene ambos polos
                if(phaseAtLamp && neutralAtLamp) {
                    bulb.classList.add('on');
                    setTimeout(() => {
                        if(bulb.classList.contains('on')) {
                            document.getElementById('win-modal').style.display = 'flex';
                            this.playSound(600, 'sine', 0.3);
                        }
                    }, 300);
                }
            }

            // --- UTILS GRAFOS ---
            buildAdjacency() {
                const adj = {};
                this.wires.forEach(w => {
                    if(!adj[w.u]) adj[w.u]=[]; if(!adj[w.v]) adj[w.v]=[];
                    adj[w.u].push(w.v); adj[w.v].push(w.u);
                });
                return adj;
            }

            hasPath(adj, start, end) {
                if(!adj[start]) return false;
                const q = [start];
                const visited = new Set([start]);
                while(q.length > 0) {
                    const u = q.shift();
                    if(u === end) return true;
                    if(adj[u]) {
                        for(const v of adj[u]) {
                            if(!visited.has(v)) {
                                visited.add(v);
                                q.push(v);
                            }
                        }
                    }
                }
                return false;
            }

            // --- UTILS VISUALES/AUDIO ---
            showErrorShake(id1, id2) {
                const el1 = document.getElementById(id1);
                const el2 = document.getElementById(id2);
                el1.classList.add('error-shake');
                el2.classList.add('error-shake');
                setTimeout(() => {
                    el1.classList.remove('error-shake');
                    el2.classList.remove('error-shake');
                }, 400);
            }

            showToast(msg, type='info') {
                const t = document.getElementById('toast');
                t.textContent = msg;
                t.style.background = type === 'error' ? '#d63031' : '#2d3436';
                t.style.opacity = 1; 
                setTimeout(() => t.style.opacity = 0, 3000);
            }

            playSound(freq, type, vol=0.1) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            }
            
            playErrorSound() {
                this.playSound(150, 'sawtooth', 0.2);
            }
        }

        const game = new Simulator();
        
        // Redibujar cables al cambiar tama√±o de ventana
        window.addEventListener('resize', () => {
            game.wires.forEach(w => game.updateWirePath(w));
        });
    </script>
</body>
</html>
