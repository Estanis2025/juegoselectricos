<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Simulador Electricista: Niveles y Tester</title>
    <style>
        :root {
            --bg-color: #2f3542;
            --wire-phase: #e74c3c;   /* Rojo */
            --wire-neutral: #3498db; /* Azul */
            --wire-earth: #2ecc71;   /* Verde */
            --wire-return: #95a5a6;  /* Gris */
            --shadow: 5px 5px 15px rgba(0,0,0,0.5);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh; user-select: none;
            color: white;
        }

        /* HEADER & UI */
        header {
            background: rgba(0,0,0,0.4); padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #555; z-index: 50;
        }

        .level-badge {
            background: #f1c40f; color: #222; padding: 5px 15px; border-radius: 20px;
            font-weight: bold; margin-right: 15px; display: inline-block;
        }

        .toolbar { display: flex; gap: 10px; }
        
        .tool-btn {
            background: #57606f; border: 1px solid #747d8c; color: white;
            padding: 8px 15px; border-radius: 5px; cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 5px;
        }
        .tool-btn:hover { background: #747d8c; }
        .tool-btn.active { background: #0984e3; border-color: #74b9ff; box-shadow: 0 0 10px #0984e3; }

        .btn-action { background: #2ed573; border: none; color: #2f3542; font-weight: bold; }
        .btn-reset { background: #ff4757; color: white; }

        /* TABLERO */
        #game-board {
            position: relative; flex-grow: 1;
            background-image: radial-gradient(#57606f 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #wire-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* CURSORES */
        #game-board[data-tool="hand"] { cursor: default; }
        #game-board[data-tool="tester"] { cursor: crosshair; }

        /* TESTER FLOTANTE */
        #multimeter {
            position: absolute; width: 140px; background: #f39c12;
            border: 4px solid #2d3436; border-radius: 10px; padding: 10px;
            box-shadow: 10px 10px 30px rgba(0,0,0,0.5);
            display: none; z-index: 100; pointer-events: none; top: 60px; left: 20px;
        }
        .lcd {
            background: #95a5a6; color: #2d3436; font-family: 'Courier New', monospace;
            font-size: 1.8rem; text-align: right; padding: 5px; border: 2px inset #7f8c8d;
            border-radius: 4px; font-weight: bold; margin-bottom: 5px;
        }
        .lcd.hot { background: #ff6b6b; color: #fff; } /* Tensi√≥n detectada */
        .lcd.cold { background: #1dd1a1; color: #2d3436; } /* Sin tensi√≥n */

        /* COMPONENTES GENERALES */
        .component {
            position: absolute; background: #dfe4ea; border-radius: 4px;
            box-shadow: var(--shadow); z-index: 2; color: #333;
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* 1. Tablero Principal */
        .comp-source { width: 100px; height: 140px; background: #2f3542; border: 2px solid #57606f; }
        .breaker-main {
            width: 50px; height: 30px; background: #ff4757; margin: 10px; border-radius: 3px;
            cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.7rem; color: white;
            box-shadow: inset 0 -3px rgba(0,0,0,0.3);
        }
        .breaker-main.on { background: #2ed573; transform: translateY(2px); box-shadow: inset 0 2px rgba(0,0,0,0.3); }

        /* 2. Disyuntor (Diferencial) */
        .comp-disyuntor { width: 80px; height: 120px; background: #f1f2f6; border: 2px solid #ced6e0; }
        .lever-dif { 
            width: 40px; height: 25px; background: #3742fa; margin-top: 15px; border-radius: 3px; cursor: pointer; color: white; text-align: center; line-height: 25px; font-size: 0.7rem;
        }
        .lever-dif.on { background: #2ed573; }

        /* 3. Tecla / Interruptor */
        .comp-switch { width: 60px; height: 90px; background: #fff; }
        .rocker { width: 30px; height: 50px; border: 1px solid #ccc; margin-top: 10px; cursor: pointer; background: #f1f2f6; }
        .rocker.active { background: #dfe4ea; border-left: 4px solid #ccc; }

        /* 4. L√°mpara */
        .comp-lamp { width: 80px; height: 80px; border-radius: 50%; background: #dfe4ea; border: 3px solid #ccc; }
        .bulb { width: 100%; height: 100%; border-radius: 50%; background: #bdc3c7; opacity: 0.3; transition: 0.3s; }
        .bulb.on { background: #f1c40f; opacity: 1; box-shadow: 0 0 50px #f1c40f; }

        /* 5. Enchufe (Tomacorriente) */
        .comp-outlet { width: 60px; height: 80px; background: #fff; border-radius: 5px; }
        .outlet-face { 
            width: 40px; height: 40px; background: #f1f2f6; border-radius: 50%; margin-top: 10px; position: relative; border: 1px solid #ccc;
        }
        /* Agujeros */
        .outlet-face::before { content:''; position:absolute; top:12px; left:8px; width:4px; height:10px; background:#333; }
        .outlet-face::after { content:''; position:absolute; top:12px; right:8px; width:4px; height:10px; background:#333; }
        .outlet-earth { position:absolute; bottom:5px; left:18px; width:4px; height:4px; background:#333; border-radius:50%; }
        
        .outlet-led { 
            width: 8px; height: 8px; background: #555; border-radius: 50%; margin-top: 5px; 
        }
        .outlet-led.on { background: #2ed573; box-shadow: 0 0 10px #2ed573; }

        /* TERMINALES */
        .terminal {
            width: 18px; height: 18px; background: #bdc3c7; border: 2px solid #57606f; border-radius: 50%;
            position: absolute; cursor: pointer; z-index: 10; transition: 0.2s;
        }
        .terminal:hover { background: #ffa502; transform: scale(1.3); }
        .lbl { position: absolute; font-size: 9px; font-weight: bold; pointer-events: none; }
        .lbl-w { color: white; } .lbl-b { color: #333; }

        /* CABLES */
        path.wire { fill: none; stroke-width: 5; stroke-linecap: round; cursor: pointer; opacity: 0.9; }
        path.wire:hover { stroke-width: 8; opacity: 1; }

        /* MENSAJES */
        #toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #2f3542; color: white; padding: 10px 20px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 2000;
            border: 1px solid #57606f;
        }
        
        #win-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .win-card {
            background: white; color: #333; padding: 30px; border-radius: 10px; text-align: center;
            max-width: 400px;
        }
    </style>
</head>
<body>

    <!-- TESTER FLOTANTE -->
    <div id="multimeter">
        <div class="lcd" id="tester-lcd">000</div>
        <div style="font-size:0.7rem; text-align:center; color:#222; font-weight:bold;">AC 750V</div>
    </div>

    <!-- MODAL VICTORIA -->
    <div id="win-modal">
        <div class="win-card">
            <h1 style="color:#2ed573;">¬°Circuito Correcto!</h1>
            <p id="win-msg">Has completado el nivel.</p>
            <button class="tool-btn btn-action" onclick="game.nextLevel()" style="width:100%; justify-content:center; margin-top:15px;">Siguiente Nivel ‚û°</button>
        </div>
    </div>

    <header>
        <div>
            <div style="font-size:1.2rem; font-weight:bold;">Simulador Pro</div>
            <div id="level-display" class="level-badge">Nivel 1</div>
        </div>
        
        <div class="toolbar">
            <button class="tool-btn active" onclick="game.setTool('hand')" id="btn-hand">
                üñê Mano (Conectar/Borrar)
            </button>
            <button class="tool-btn" onclick="game.setTool('tester')" id="btn-tester">
                üìü Tester
            </button>
        </div>

        <button class="tool-btn btn-reset" onclick="game.resetLevel()">Reiniciar Nivel</button>
    </header>

    <div id="game-board" data-tool="hand">
        <svg id="wire-layer"></svg>
        <div id="components-layer"></div> <!-- Los componentes se generan por JS -->
        <div id="toast"></div>
    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";

        // CONFIGURACI√ìN DE NIVELES
        const levels = [
            {
                id: 1, name: "B√°sico",
                comps: [
                    { type: 'source', x: 5, y: 10 },
                    { type: 'switch', id: 'S1', x: 40, y: 60 },
                    { type: 'lamp', id: 'L1', x: 70, y: 30 }
                ]
            },
            {
                id: 2, name: "Conexi√≥n en Serie",
                comps: [
                    { type: 'source', x: 5, y: 10 },
                    { type: 'switch', id: 'S1', x: 30, y: 60 },
                    { type: 'lamp', id: 'L1', x: 60, y: 30 },
                    { type: 'lamp', id: 'L2', x: 80, y: 30 }
                ]
            },
            {
                id: 3, name: "Instalaci√≥n Completa",
                comps: [
                    { type: 'source', x: 5, y: 10 },
                    { type: 'disyuntor', id: 'D1', x: 25, y: 10 }, // Nuevo componente
                    { type: 'outlet', id: 'T1', x: 25, y: 60 },    // Nuevo componente
                    { type: 'switch', id: 'S1', x: 50, y: 60 },
                    { type: 'lamp', id: 'L1', x: 80, y: 30 }
                ]
            }
        ];

        class Simulator {
            constructor() {
                this.wires = [];
                this.levelIdx = 0;
                this.tool = 'hand';
                this.dragStart = null;
                
                // Estado Componentes
                this.breakerOn = false; // T√©rmica principal
                this.switches = {};     // Estado teclas
                this.disyuntores = {};  // Estado disyuntores

                // DOM
                this.board = document.getElementById('game-board');
                this.svg = document.getElementById('wire-layer');
                this.compLayer = document.getElementById('components-layer');
                
                // Tester
                this.tester = document.getElementById('multimeter');
                this.lcd = document.getElementById('tester-lcd');

                this.initInteraction();
                this.loadLevel(0);
            }

            loadLevel(idx) {
                this.levelIdx = idx;
                const lvl = levels[idx];
                document.getElementById('level-display').textContent = `Nivel ${lvl.id}: ${lvl.name}`;
                document.getElementById('win-modal').style.display = 'none';
                
                this.wires = [];
                this.svg.innerHTML = '';
                this.compLayer.innerHTML = '';
                this.breakerOn = false;
                this.switches = {};
                this.disyuntores = {};

                // Render Componentes
                lvl.comps.forEach(c => this.renderComponent(c));
                
                this.showToast(`Nivel ${lvl.id} Iniciado. ¬°Doble click para borrar cables!`);
                this.updateCircuit();
            }

            renderComponent(c) {
                const el = document.createElement('div');
                el.style.left = c.x + '%';
                el.style.top = c.y + '%';
                
                let html = '';
                if(c.type === 'source') {
                    el.className = 'component comp-source';
                    html = `
                        <div style="margin-top:10px; color:#fff; font-weight:bold;">220V</div>
                        <div id="breaker-main" class="breaker-main" onclick="game.toggleBreaker()">OFF</div>
                        <div style="position:relative; width:100%; height:80px;">
                            <div class="terminal" id="t-src-L" style="top:5px; right:-10px; background:var(--wire-phase);"></div><span class="lbl lbl-w" style="top:7px; right:15px;">L</span>
                            <div class="terminal" id="t-src-N" style="top:35px; right:-10px; background:var(--wire-neutral);"></div><span class="lbl lbl-w" style="top:37px; right:15px;">N</span>
                            <div class="terminal" id="t-src-E" style="top:65px; right:-10px; background:var(--wire-earth);"></div><span class="lbl lbl-w" style="top:67px; right:15px;">T</span>
                        </div>`;
                } else if(c.type === 'disyuntor') {
                    el.className = 'component comp-disyuntor';
                    this.disyuntores[c.id] = true; // Default ON
                    html = `
                        <div style="font-size:0.7rem; margin-top:5px;">Disyuntor</div>
                        <div id="lever-${c.id}" class="lever-dif on" onclick="game.toggleDisyuntor('${c.id}')">ON</div>
                        <!-- Entrada -->
                        <div class="terminal" id="t-${c.id}-inL" style="top:10px; left:-10px;"></div>
                        <div class="terminal" id="t-${c.id}-inN" style="top:40px; left:-10px;"></div>
                        <!-- Salida -->
                        <div class="terminal" id="t-${c.id}-outL" style="top:10px; right:-10px;"></div>
                        <div class="terminal" id="t-${c.id}-outN" style="top:40px; right:-10px;"></div>
                    `;
                } else if(c.type === 'switch') {
                    el.className = 'component comp-switch';
                    this.switches[c.id] = false;
                    html = `
                        <div class="rocker" id="rocker-${c.id}" onclick="game.toggleSwitch('${c.id}')"></div>
                        <div class="terminal" id="t-${c.id}-in" style="top:20px; left:-10px;"></div><span class="lbl lbl-b" style="top:22px; left:12px;">L</span>
                        <div class="terminal" id="t-${c.id}-out" style="top:60px; right:-10px;"></div><span class="lbl lbl-b" style="top:62px; right:12px;">1</span>
                    `;
                } else if(c.type === 'lamp') {
                    el.className = 'component comp-lamp';
                    html = `
                        <div class="bulb" id="bulb-${c.id}"></div>
                        <div class="terminal" id="t-${c.id}-L" style="bottom:-5px; left:10px;"></div>
                        <div class="terminal" id="t-${c.id}-N" style="bottom:-5px; right:10px;"></div>
                    `;
                } else if(c.type === 'outlet') {
                    el.className = 'component comp-outlet';
                    html = `
                        <div class="outlet-face">
                            <div class="outlet-earth"></div>
                        </div>
                        <div id="led-${c.id}" class="outlet-led"></div>
                        <div class="terminal" id="t-${c.id}-L" style="top:15px; right:-10px;"></div>
                        <div class="terminal" id="t-${c.id}-N" style="top:15px; left:-10px;"></div>
                        <div class="terminal" id="t-${c.id}-E" style="bottom:5px; left:25px; background:var(--wire-earth);"></div>
                    `;
                }
                
                el.innerHTML = html;
                this.compLayer.appendChild(el);
            }

            // --- L√ìGICA EL√âCTRICA ---
            calculatePotentials() {
                const map = new Map(); // terminalID -> voltage (220 or 0)
                if(!this.breakerOn) return map; // Sin energ√≠a principal

                const adj = this.buildAdjacency();

                // 1. Fase (220V)
                this.bfs(adj, 't-src-L', node => map.set(node, 220));

                // 2. Neutro (0V)
                this.bfs(adj, 't-src-N', node => { if(!map.has(node)) map.set(node, 0); });
                
                // 3. Tierra (0V)
                this.bfs(adj, 't-src-E', node => { if(!map.has(node)) map.set(node, 0); });

                return map;
            }

            // BFS personalizado que atraviesa componentes si est√°n ON
            bfs(adj, start, callback) {
                let q = [start];
                let visited = new Set([start]);
                
                while(q.length > 0) {
                    let u = q.shift();
                    callback(u);

                    // A. Conexiones por cable
                    if(adj[u]) {
                        for(let v of adj[u]) {
                            if(!visited.has(v)) { visited.add(v); q.push(v); }
                        }
                    }

                    // B. Conexiones internas de componentes
                    // Switch
                    if(u.includes('switch') || (u.includes('S') && u.includes('in'))) { // Simple check
                        const swId = u.split('-')[1]; // S1
                        if(this.switches[swId]) {
                            const partner = u.includes('in') ? `t-${swId}-out` : `t-${swId}-in`;
                            if(!visited.has(partner)) { visited.add(partner); q.push(partner); }
                        }
                    }
                    // Disyuntor (Pasa L-L y N-N si est√° ON)
                    if(u.includes('D') && u.includes('in')) {
                        const dId = u.split('-')[1]; // D1
                        const type = u.slice(-1); // L or N
                        if(this.disyuntores[dId]) {
                            const out = `t-${dId}-out${type}`;
                            if(!visited.has(out)) { visited.add(out); q.push(out); }
                        }
                    }
                    // L√°mparas en serie: conducen internamente L <-> N
                    // (Simulaci√≥n simple: l√°mparas son "resistencias", la corriente pasa)
                    if(u.includes('lamp') || u.includes('L')) {
                        // Detectar si es terminal de l√°mpara
                        const parts = u.split('-');
                        if(parts[0] === 't' && parts[1].startsWith('L') && (parts[2] === 'L' || parts[2] === 'N')) {
                            const partner = parts[2] === 'L' ? `t-${parts[1]}-N` : `t-${parts[1]}-L`;
                            if(!visited.has(partner)) { visited.add(partner); q.push(partner); }
                        }
                    }
                }
            }

            updateCircuit() {
                const map = this.calculatePotentials();
                const lvl = levels[this.levelIdx];
                let lampsOK = 0;
                let outletsOK = 0;
                let totalLamps = 0;
                let totalOutlets = 0;

                // Verificar Componentes
                lvl.comps.forEach(c => {
                    if(c.type === 'lamp') {
                        totalLamps++;
                        const vL = map.get(`t-${c.id}-L`);
                        const vN = map.get(`t-${c.id}-N`);
                        // L√°mpara enciende si hay diferencia de potencial (220 y 0)
                        // Para serie, simplificamos: si llega fase por un lado y neutro por el otro a la cadena.
                        // En l√≥gica BFS arriba, la fase "inunda" todo. Para serie real se necesita an√°lisis de circuito.
                        // TRUCO SIMULACI√ìN: Si vL es 220 y vN es 0 (o viceversa), prende.
                        // Pero el BFS de fase "cruza" la l√°mpara. As√≠ que ambos lados tendr√≠an 220 si no llega neutro "fuerte".
                        // REFINAMIENTO: El neutro debe llegar desde el origen N.
                        
                        // L√≥gica simple robusta:
                        // Check if L pin traces to Source L AND N pin traces to Source N.
                        if(this.checkContinuity(`t-${c.id}-L`, 't-src-L') && this.checkContinuity(`t-${c.id}-N`, 't-src-N')) {
                             document.getElementById(`bulb-${c.id}`).classList.add('on');
                             lampsOK++;
                        } else {
                             document.getElementById(`bulb-${c.id}`).classList.remove('on');
                        }
                    }
                    if(c.type === 'outlet') {
                        totalOutlets++;
                        // Enchufe OK si Fase=220, Neutro=0, Tierra=0
                        const vL = map.get(`t-${c.id}-L`);
                        const vN = map.get(`t-${c.id}-N`); // 0 derivado de src-N
                        const vE = map.get(`t-${c.id}-E`); // 0 derivado de src-E
                        
                        // Validaci√≥n m√°s estricta: Continuidad
                        const hasL = this.checkContinuity(`t-${c.id}-L`, 't-src-L');
                        const hasN = this.checkContinuity(`t-${c.id}-N`, 't-src-N');
                        const hasE = this.checkContinuity(`t-${c.id}-E`, 't-src-E');

                        if(hasL && hasN && hasE) {
                            document.getElementById(`led-${c.id}`).classList.add('on');
                            outletsOK++;
                        } else {
                            document.getElementById(`led-${c.id}`).classList.remove('on');
                        }
                    }
                });

                // VICTORIA
                if(lampsOK === totalLamps && outletsOK === totalOutlets) {
                    setTimeout(() => document.getElementById('win-modal').style.display = 'flex', 500);
                }
            }

            // Verifica si hay camino f√≠sico/l√≥gico entre dos puntos
            checkContinuity(start, target) {
                if(!this.breakerOn) return false; // Sin energ√≠a no hay "continuidad activa" para la l√≥gica de victoria
                // (Para tester es distinto, pero aqu√≠ usamos l√≥gica de estado)
                const adj = this.buildAdjacency();
                let found = false;
                
                // BFS Espec√≠fico que NO cruza l√°mparas (para ver si llega Neutro real, no fase retornada)
                // Modificamos BFS para que las cargas (l√°mparas) no sean puentes perfectos en esta validaci√≥n direccional
                // Simplificaci√≥n: Usar el mapa de potenciales.
                // Si map.get(node) === 220, est√° conectado a fase.
                // Si map.get(node) === 0, est√° conectado a neutro/tierra.
                // Esto ya lo hace calculatePotentials diferenciando or√≠genes.
                
                const map = this.calculatePotentials();
                
                if(target === 't-src-L') return map.get(start) === 220;
                if(target === 't-src-N') {
                    // Aqu√≠ est√° el truco: calculatePotentials pone 0 a lo que toca N.
                    // Pero si la fase entra por el otro lado de la l√°mpara, el nodo tendr√≠a 220.
                    // Necesitamos saber si TOCA N.
                    // Recalcular solo N
                    let isN = false;
                    this.bfs(adj, 't-src-N', n => { if(n===start) isN = true; });
                    return isN;
                }
                if(target === 't-src-E') {
                    let isE = false;
                    this.bfs(adj, 't-src-E', n => { if(n===start) isE = true; });
                    return isE;
                }
                return false;
            }

            buildAdjacency() {
                const adj = {};
                this.wires.forEach(w => {
                    if(!adj[w.u]) adj[w.u]=[]; if(!adj[w.v]) adj[w.v]=[];
                    adj[w.u].push(w.v); adj[w.v].push(w.u);
                });
                return adj;
            }

            // --- CONTROLES ---
            toggleBreaker() {
                this.breakerOn = !this.breakerOn;
                const b = document.getElementById('breaker-main');
                if(this.breakerOn) b.classList.add('on'); else b.classList.remove('on');
                this.updateCircuit();
            }
            toggleSwitch(id) {
                this.switches[id] = !this.switches[id];
                const el = document.getElementById(`rocker-${id}`);
                if(this.switches[id]) el.classList.add('active'); else el.classList.remove('active');
                this.updateCircuit();
            }
            toggleDisyuntor(id) {
                this.disyuntores[id] = !this.disyuntores[id];
                const el = document.getElementById(`lever-${id}`);
                if(this.disyuntores[id]) el.classList.add('on'); else el.classList.remove('on');
                this.updateCircuit();
            }

            // --- HERRAMIENTAS ---
            setTool(t) {
                this.tool = t;
                document.getElementById('game-board').dataset.tool = t;
                document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                if(t==='hand') document.getElementById('btn-hand').classList.add('active');
                if(t==='tester') document.getElementById('btn-tester').classList.add('active');
                
                this.tester.style.display = 'none';
            }

            handleMouseMove(e) {
                if(this.tool === 'tester') {
                    this.tester.style.display = 'block';
                    this.tester.style.left = (e.clientX + 15) + 'px';
                    this.tester.style.top = (e.clientY + 15) + 'px';
                    
                    const el = document.elementFromPoint(e.clientX, e.clientY);
                    let voltage = 0;
                    
                    // Detectar si est√° sobre un terminal o cable
                    if(el) {
                        const map = this.calculatePotentials();
                        let id = null;
                        
                        if(el.classList.contains('terminal')) id = el.id;
                        else if(el.classList.contains('wire')) {
                            const w = this.wires.find(wire => wire.el === el);
                            if(w) id = w.u; // Aproximaci√≥n: toma voltaje de un extremo
                        }

                        if(id && map.has(id)) {
                            voltage = map.get(id);
                        }
                    }

                    this.lcd.textContent = voltage > 0 ? "220 V" : "000 V";
                    if(voltage > 0) {
                        this.lcd.className = "lcd hot";
                    } else {
                        this.lcd.className = "lcd cold";
                    }
                }
            }

            // --- CABLEADO ---
            initInteraction() {
                // Click terminal para conectar
                this.compLayer.addEventListener('mousedown', (e) => {
                    if(e.target.classList.contains('terminal')) {
                        if(this.tool === 'hand') {
                            e.stopPropagation();
                            this.dragStart = e.target.id;
                        }
                    }
                });

                // Doble click para borrar
                this.compLayer.addEventListener('dblclick', (e) => {
                    if(e.target.classList.contains('terminal') && this.tool === 'hand') {
                        const id = e.target.id;
                        const toRemove = this.wires.filter(w => w.u === id || w.v === id);
                        if(toRemove.length > 0) {
                            toRemove.forEach(w => w.el.remove());
                            this.wires = this.wires.filter(w => w.u !== id && w.v !== id);
                            this.showToast("Cables desconectados");
                            this.updateCircuit();
                        }
                    }
                });

                window.addEventListener('mouseup', (e) => {
                    if(this.dragStart) {
                        const el = document.elementFromPoint(e.clientX, e.clientY);
                        if(el && el.classList.contains('terminal') && el.id !== this.dragStart) {
                            this.addWire(this.dragStart, el.id);
                        }
                        this.dragStart = null;
                    }
                });

                window.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                window.addEventListener('resize', () => this.wires.forEach(w => this.drawWire(w)));
            }

            addWire(u, v) {
                // Check duplicados
                if(this.wires.find(w => (w.u===u && w.v===v) || (w.u===v && w.v===u))) return;

                // Color
                let color = '#7f8fa6';
                if(u.includes('L') || v.includes('L')) color = 'var(--wire-phase)';
                else if(u.includes('N') || v.includes('N')) color = 'var(--wire-neutral)';
                else if(u.includes('E') || v.includes('E')) color = 'var(--wire-earth)';

                const path = document.createElementNS(svgNS, 'path');
                path.classList.add('wire');
                path.setAttribute('stroke', color);
                this.svg.appendChild(path);

                const wire = { u, v, el: path };
                this.wires.push(wire);
                this.drawWire(wire);
                this.updateCircuit();
            }

            drawWire(w) {
                const el1 = document.getElementById(w.u);
                const el2 = document.getElementById(w.v);
                if(!el1 || !el2) return;
                
                const r1 = el1.getBoundingClientRect();
                const r2 = el2.getBoundingClientRect();
                const br = this.board.getBoundingClientRect();

                const x1 = r1.left + r1.width/2 - br.left;
                const y1 = r1.top + r1.height/2 - br.top;
                const x2 = r2.left + r2.width/2 - br.left;
                const y2 = r2.top + r2.height/2 - br.top;

                // Curva en U
                const cx1 = x1, cy1 = Math.max(y1, y2) + 50;
                const cx2 = x2, cy2 = Math.max(y1, y2) + 50;

                w.el.setAttribute('d', `M ${x1} ${y1} C ${cx1} ${cy1}, ${cx2} ${cy2}, ${x2} ${y2}`);
            }

            showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.style.opacity = 1;
                setTimeout(() => t.style.opacity = 0, 3000);
            }

            resetLevel() { this.loadLevel(this.levelIdx); }
            nextLevel() { 
                if(this.levelIdx < levels.length - 1) this.loadLevel(this.levelIdx + 1); 
                else this.showToast("¬°Juego Completado! Felicitaciones.");
            }
        }

        const game = new Simulator();
    </script>
</body>
</html>
