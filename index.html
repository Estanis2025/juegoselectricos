<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taller Eléctrico: Instalación Segura</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            /* Colores Norma IEC/Argentina */
            --wire-phase: #8B4513;   /* Marrón (Fase) */
            --wire-neutral: #3498db; /* Celeste (Neutro) */
            --wire-earth: #2ecc71;   /* Verde/Amarillo (Tierra) */
            --wire-return: #2c3e50;  /* Negro (Retorno) */
            
            --terminal-size: 18px;
            --shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh; user-select: none;
        }

        /* HEADER */
        header {
            background: #2c3e50; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); z-index: 10;
        }
        .tool-panel { display: flex; gap: 15px; align-items: center; }
        .status-badge { 
            background: #e74c3c; padding: 5px 12px; border-radius: 4px; 
            font-weight: bold; font-size: 0.9rem; text-transform: uppercase;
        }

        /* TABLERO JUEGO */
        #game-board {
            position: relative; flex-grow: 1;
            background-image: 
                linear-gradient(#d1d8e0 1px, transparent 1px),
                linear-gradient(90deg, #d1d8e0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
        }

        /* BUSCAPOLO CURSOR (Simulado visualmente) */
        #game-board.tester-mode { cursor: help; }

        #wire-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* COMPONENTES */
        .component {
            position: absolute; background: white; border: 2px solid #7f8c8d; border-radius: 6px;
            box-shadow: var(--shadow); z-index: 2; display: flex; flex-direction: column; align-items: center;
        }
        
        /* CAJA TÉRMICA PRINCIPAL */
        .comp-main-panel { 
            width: 120px; height: 160px; background: #34495e; color: white; 
            border: 3px solid #2c3e50; left: 5%; top: 20%;
        }
        .breaker-handle {
            width: 60px; height: 40px; background: #e74c3c; margin: 10px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: inset 0 -4px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .breaker-handle.on { background: #27ae60; transform: translateY(2px); box-shadow: inset 0 2px rgba(0,0,0,0.2); }
        .breaker-handle::after { content: 'OFF'; }
        .breaker-handle.on::after { content: 'ON'; }

        /* INTERRUPTOR (TECLA) */
        .comp-switch { 
            width: 80px; height: 100px; left: 40%; top: 60%;
            background: #ecf0f1;
        }
        .switch-rocker {
            width: 40px; height: 60px; background: #fff; border: 1px solid #ccc;
            cursor: pointer; margin-top: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .switch-rocker.active { border-left: 4px solid #ccc; background: #f9f9f9; }

        /* LÁMPARA */
        .comp-lamp { 
            width: 80px; height: 80px; border-radius: 50%; left: 70%; top: 30%;
            border: 4px solid #bdc3c7; display: flex; justify-content: center; align-items: center;
        }
        .bulb { width: 100%; height: 100%; background: #95a5a6; border-radius: 50%; transition: 0.3s; opacity: 0.5; }
        .bulb.on { background: #f1c40f; opacity: 1; box-shadow: 0 0 50px #f1c40f; }

        /* TERMINALES */
        .terminal {
            width: var(--terminal-size); height: var(--terminal-size);
            background: #bdc3c7; border: 2px solid #555; border-radius: 50%;
            position: absolute; cursor: crosshair; z-index: 10;
        }
        .terminal:hover { transform: scale(1.2); background: #f39c12; }
        
        /* Etiquetas de terminales */
        .term-label { position: absolute; font-size: 10px; font-weight: bold; pointer-events: none; color: #333; }

        /* CABLES */
        path.wire { fill: none; stroke-width: 6; stroke-linecap: round; cursor: pointer; opacity: 0.9; }
        path.wire:hover { stroke-width: 9; opacity: 1; }
        /* Efecto Buscapolo */
        path.wire.voltage { filter: drop-shadow(0 0 4px red); } 

        /* ALERTA FLOTANTE */
        #alert-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #c0392b; color: white; padding: 15px 25px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: opacity 0.3s; pointer-events: none; text-align: center; z-index: 100;
        }
        
        .info-card {
            position: absolute; top: 70px; right: 20px; width: 250px;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px;
            border-left: 5px solid #3498db; font-size: 0.85rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-card h4 { margin: 0 0 5px 0; color: #2c3e50; }
        .wire-legend { display: flex; align-items: center; gap: 5px; margin: 2px 0; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

    </style>
</head>
<body>

    <header>
        <div>
            <h1 style="margin:0; font-size:1.2rem;">Taller de Electricidad ⚡</h1>
            <small>Práctica: Instalación de Punto y Toma simple</small>
        </div>
        <div class="tool-panel">
            <div id="tester-indicator" class="status-badge" style="background:#7f8c8d;">BUSCAPOLO: OFF</div>
            <button onclick="game.reset()" style="padding:5px 15px; cursor:pointer;">Reiniciar</button>
        </div>
    </header>

    <div id="game-board">
        <svg id="wire-layer"></svg>

        <!-- CAJA DE INFORMACIÓN / AYUDA -->
        <div class="info-card">
            <h4>Código de Colores</h4>
            <div class="wire-legend"><div class="dot" style="background:#8B4513"></div> Fase (Marrón/Rojo)</div>
            <div class="wire-legend"><div class="dot" style="background:#3498db"></div> Neutro (Celeste)</div>
            <div class="wire-legend"><div class="dot" style="background:#2c3e50"></div> Retorno (Negro)</div>
            <div class="wire-legend"><div class="dot" style="background:#2ecc71"></div> Tierra (Verde/Amarillo)</div>
            <hr>
            <strong>Regla de Oro:</strong> ¡Cortá la luz antes de trabajar!
        </div>

        <!-- 1. TABLERO GENERAL -->
        <div class="component comp-main-panel">
            <div style="text-align:center; padding:5px; font-weight:bold;">TÉRMICA</div>
            <div id="main-breaker" class="breaker-handle" onclick="game.togglePower()"></div>
            
            <!-- Terminales Salida -->
            <div style="position:relative; height:100px;">
                <span class="term-label" style="top:12px; right:25px; color:white;">Fase</span>
                <div class="terminal" id="t-source-phase" data-type="phase" style="top:10px; right:-10px; background:#8B4513;"></div>
                
                <span class="term-label" style="top:42px; right:25px; color:white;">Neutro</span>
                <div class="terminal" id="t-source-neutral" data-type="neutral" style="top:40px; right:-10px; background:#3498db;"></div>
                
                <span class="term-label" style="top:72px; right:25px; color:white;">Tierra</span>
                <div class="terminal" id="t-source-earth" data-type="earth" style="top:70px; right:-10px; background:#2ecc71;"></div>
            </div>
        </div>

        <!-- 2. INTERRUPTOR (TECLA) -->
        <div class="component comp-switch">
            <div style="margin-top:5px; font-weight:bold; font-size:12px;">TECLA</div>
            <!-- Parte trasera simulada (conexiones) -->
            
            <!-- Entrada (L) -->
            <div class="terminal" id="t-sw-in" style="top:30px; left:-10px;"></div>
            <span class="term-label" style="top:32px; left:12px;">L (Entrada)</span>
            
            <!-- Salida (1) Retorno -->
            <div class="terminal" id="t-sw-out" style="top:70px; right:-10px;"></div>
            <span class="term-label" style="top:72px; right:12px;">1 (Retorno)</span>

            <!-- Botón visual frontal (para probar) -->
            <div class="switch-rocker" id="visual-switch" onclick="game.pressSwitch()"></div>
        </div>

        <!-- 3. LÁMPARA -->
        <div class="component comp-lamp">
            <div class="bulb" id="bulb"></div>
            <!-- Terminales -->
            <div class="terminal" id="t-lamp-L" style="bottom:-10px; left:10px;"></div>
            <span class="term-label" style="bottom:15px; left:15px; font-size:9px;">Fase/Ret</span>
            
            <div class="terminal" id="t-lamp-N" style="bottom:-10px; right:10px;"></div>
            <span class="term-label" style="bottom:15px; right:15px; font-size:9px;">Neutro</span>

            <div class="terminal" id="t-lamp-E" style="top:-10px; left:30px; background:#2ecc71;"></div>
            <span class="term-label" style="top:10px; left:25px; font-size:8px;">Chapa</span>
        </div>

        <div id="alert-box"></div>
    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";

        class ElectricalGame {
            constructor() {
                this.wires = [];
                this.isPowerOn = false; // Empezamos con luz cortada (Seguro)
                this.switchClosed = false;
                
                this.svg = document.getElementById('wire-layer');
                this.dragState = null;
                
                this.initInteraction();
                this.showAlert("PASO 1: Verificá que la térmica esté baja antes de cablear.");
            }

            // --- SEGURIDAD: CONTROL DE ENERGÍA ---
            togglePower() {
                this.isPowerOn = !this.isPowerOn;
                const handle = document.getElementById('main-breaker');
                const tester = document.getElementById('tester-indicator');
                
                if (this.isPowerOn) {
                    handle.classList.add('on');
                    tester.style.background = "#e67e22"; // Naranja activo
                    tester.textContent = "BUSCAPOLO: ACTIVO";
                    this.showAlert("¡Corriente ACTIVADA! Usa el buscapolo. No toques cables.");
                } else {
                    handle.classList.remove('on');
                    tester.style.background = "#7f8c8d";
                    tester.textContent = "BUSCAPOLO: OFF";
                    this.showAlert("Corriente cortada. Es seguro trabajar.");
                }
                this.validateCircuit();
            }

            pressSwitch() {
                this.switchClosed = !this.switchClosed;
                document.getElementById('visual-switch').classList.toggle('active');
                // Sonido click
                this.playSound(300, 'square', 0.05);
                this.validateCircuit();
            }

            // --- INTERACCIÓN DE CABLEADO ---
            initInteraction() {
                document.querySelectorAll('.terminal').forEach(t => {
                    t.addEventListener('pointerdown', (e) => this.startDrag(e));
                });
                document.addEventListener('pointermove', (e) => this.drag(e));
                document.addEventListener('pointerup', (e) => this.endDrag(e));
            }

            startDrag(e) {
                // REGLA DE SEGURIDAD CRÍTICA
                if (this.isPowerOn) {
                    this.triggerError("¡PELIGRO DE ELECTROCUCIÓN! Cortá la térmica primero.");
                    this.playSound(100, 'sawtooth', 0.5); // Sonido error grave
                    return;
                }

                const t = e.target;
                this.dragState = {
                    startId: t.id,
                    startEl: t,
                    path: this.createTempPath()
                };

                // Auto-determinación del color del cable según origen
                const type = this.getTerminalType(t.id);
                let color = '#555'; // Default
                if (type === 'phase') color = 'var(--wire-phase)'; // Marrón
                if (type === 'neutral') color = 'var(--wire-neutral)'; // Celeste
                if (type === 'earth') color = 'var(--wire-earth)'; // Verde
                if (type === 'return') color = 'var(--wire-return)'; // Negro (Retorno)

                this.dragState.path.setAttribute('stroke', color);
            }

            drag(e) {
                if (!this.dragState) return;
                const rect = document.getElementById('game-board').getBoundingClientRect();
                const startRect = this.dragState.startEl.getBoundingClientRect();
                
                const x1 = startRect.left + startRect.width/2 - rect.left;
                const y1 = startRect.top + startRect.height/2 - rect.top;
                const x2 = e.clientX - rect.left;
                const y2 = e.clientY - rect.top;
                
                this.dragState.path.setAttribute('d', `M ${x1} ${y1} L ${x2} ${y2}`);
            }

            endDrag(e) {
                if (!this.dragState) return;
                this.dragState.path.remove();

                const endEl = document.elementFromPoint(e.clientX, e.clientY);
                
                if (endEl && endEl.classList.contains('terminal') && endEl.id !== this.dragState.startId) {
                    this.connectWires(this.dragState.startId, endEl.id, this.dragState.path.getAttribute('stroke'));
                }
                this.dragState = null;
            }

            getTerminalType(id) {
                // Lógica de colores según de dónde arrastras
                if (id === 't-source-phase') return 'phase';
                if (id === 't-source-neutral') return 'neutral';
                if (id === 't-source-earth' || id === 't-lamp-E') return 'earth';
                if (id === 't-sw-out') return 'return'; // Del interruptor a la lámpara es retorno
                return 'phase'; // Default para input de interruptor
            }

            connectWires(idA, idB, color) {
                // Verificar duplicados
                if (this.wires.some(w => (w.u === idA && w.v === idB) || (w.u === idB && w.v === idA))) return;

                const path = document.createElementNS(svgNS, "path");
                path.classList.add('wire');
                path.setAttribute('stroke', color);
                
                // Evento click en cable (Simula Buscapolo o Desconexión)
                path.addEventListener('click', (e) => this.handleWireClick(e, wireObj));
                
                this.svg.appendChild(path);
                
                const wireObj = { u: idA, v: idB, el: path, color: color };
                this.wires.push(wireObj);
                this.updateWireVisuals();
                this.playSound(600, 'sine', 0.1); // Click conexión
            }

            handleWireClick(e, wire) {
                if (this.isPowerOn) {
                    // Modo Buscapolo: Indicar si hay tensión
                    const hasVoltage = this.checkVoltageOnWire(wire);
                    if (hasVoltage) {
                        this.showAlert("⚡ BUSCAPOLO: ¡HAY TENSIÓN! (220V)");
                        this.playSound(800, 'square', 0.1);
                    } else {
                        this.showAlert("Buscapolo: Sin tensión.");
                    }
                } else {
                    // Modo Trabajo: Desconectar
                    if (confirm("¿Quitar este cable?")) {
                        wire.el.remove();
                        this.wires = this.wires.filter(w => w !== wire);
                        this.playSound(400, 'sine', 0.1);
                    }
                }
            }

            // --- LÓGICA DE VALIDACIÓN (EL CEREBRO) ---
            validateCircuit() {
                const bulb = document.getElementById('bulb');
                bulb.classList.remove('on');
                this.wires.forEach(w => w.el.classList.remove('voltage')); // Reset buscapolo visual

                if (!this.isPowerOn) return;

                // Construir grafo
                const adj = {};
                const addEdge = (u,v) => {
                    if(!adj[u]) adj[u]=[]; if(!adj[v]) adj[v]=[];
                    adj[u].push(v); adj[v].push(u);
                };

                this.wires.forEach(w => addEdge(w.u, w.v));

                // Helper BFS
                const isConnected = (start, target) => {
                    if (!adj[start]) return false;
                    let q = [start];
                    let visited = new Set([start]);
                    while (q.length) {
                        let curr = q.shift();
                        if (curr === target) return true;
                        if (adj[curr]) {
                            for (let neighbor of adj[curr]) {
                                if (!visited.has(neighbor)) {
                                    visited.add(neighbor);
                                    q.push(neighbor);
                                }
                            }
                        }
                    }
                    return false;
                };

                // --- VALIDACIONES DE SEGURIDAD (ERRORES GRAVES) ---
                
                // 1. NEUTRO EN TECLA: ¿El neutro toca la tecla?
                // Chequear si hay camino desde Fuente-Neutro hasta Switch-IN o Switch-OUT
                const neutralToSwitch = isConnected('t-source-neutral', 't-sw-in') || isConnected('t-source-neutral', 't-sw-out');
                if (neutralToSwitch) {
                    this.triggerError("❌ ERROR GRAVE: ¡Conectaste el Neutro a la tecla! La tecla solo corta la FASE.");
                    this.tripBreaker();
                    return;
                }

                // 2. FASE DIRECTA A LÁMPARA (Sin pasar por tecla)
                // Esto no es "corto", pero la luz quedaría siempre prendida.
                
                // --- SIMULACIÓN DE CORRIENTE ---
                
                // A. ¿Llega FASE a la entrada de la tecla?
                const phaseToSwitchIn = isConnected('t-source-phase', 't-sw-in');
                
                // B. ¿Tecla cerrada conecta In con Out?
                const switchConducts = this.switchClosed;

                // C. ¿Llega RETORNO desde tecla a lámpara?
                const switchOutToLamp = isConnected('t-sw-out', 't-lamp-L');

                // D. ¿Llega NEUTRO a la lámpara?
                const neutralToLamp = isConnected('t-source-neutral', 't-lamp-N'); // Estándar: Neutro a rosca (N)
                
                // E. ¿Llega TIERRA a la lámpara?
                const earthToLamp = isConnected('t-source-earth', 't-lamp-E');

                // ESTADO FINAL
                if (phaseToSwitchIn && switchConducts && switchOutToLamp && neutralToLamp) {
                    bulb.classList.add('on'); // ¡LUZ!
                    this.showAlert("✅ ¡Excelente! Instalación correcta.");
                } else {
                    if (this.switchClosed && (!phaseToSwitchIn || !switchOutToLamp)) {
                        this.showAlert("La tecla está activada pero no llega corriente a la lámpara.");
                    } else if (this.switchClosed && !neutralToLamp) {
                         this.showAlert("Falta conectar el Neutro directo a la lámpara.");
                    }
                }

                // Visualización de Tensión (Buscapolo)
                // Colorear cables que tienen Fase Viva
                this.wires.forEach(w => {
                    // Si el cable está conectado a la Fase directamente
                    if (isConnected('t-source-phase', w.u) || isConnected('t-source-phase', w.v)) {
                        w.el.classList.add('voltage');
                    }
                    // Si el cable es retorno y la tecla está cerrada y tiene fase
                    if (this.switchClosed && phaseToSwitchIn) {
                        // Chequeo simplificado visual
                        if (w.u === 't-sw-out' || w.v === 't-sw-out') w.el.classList.add('voltage');
                    }
                });
            }

            checkVoltageOnWire(wire) {
                // Simple: Si el cable toca Fase Directa O (Fase a través de tecla cerrada)
                // Nota: Esto requiere reconstruir el grafo dentro de la función, simplificamos:
                return wire.el.classList.contains('voltage');
            }

            triggerError(msg) {
                const box = document.getElementById('alert-box');
                box.style.background = "#c0392b";
                box.textContent = msg;
                box.style.opacity = 1;
                this.playSound(100, 'sawtooth', 0.8);
                setTimeout(() => box.style.opacity = 0, 5000);
            }

            showAlert(msg) {
                const box = document.getElementById('alert-box');
                box.style.background = "#27ae60";
                box.textContent = msg;
                box.style.opacity = 1;
                setTimeout(() => box.style.opacity = 0, 3000);
            }

            tripBreaker() {
                // Saltar térmica
                this.isPowerOn = false;
                document.getElementById('main-breaker').classList.remove('on');
                document.getElementById('tester-indicator').style.background = "#7f8c8d";
                document.getElementById('tester-indicator').textContent = "BUSCAPOLO: OFF";
            }

            createTempPath() {
                const path = document.createElementNS(svgNS, "path");
                path.setAttribute('fill', 'none');
                path.setAttribute('stroke-width', '4');
                path.setAttribute('stroke-dasharray', '5,5');
                this.svg.appendChild(path);
                return path;
            }

            updateWireVisuals() {
                const rect = document.getElementById('game-board').getBoundingClientRect();
                this.wires.forEach(w => {
                    const r1 = document.getElementById(w.u).getBoundingClientRect();
                    const r2 = document.getElementById(w.v).getBoundingClientRect();
                    
                    const x1 = r1.left + r1.width/2 - rect.left;
                    const y1 = r1.top + r1.height/2 - rect.top;
                    const x2 = r2.left + r2.width/2 - rect.left;
                    const y2 = r2.top + r2.height/2 - rect.top;

                    // Curva realista
                    const drop = Math.abs(x2 - x1) * 0.2 + 30;
                    w.el.setAttribute('d', `M ${x1} ${y1} C ${x1} ${y1+drop}, ${x2} ${y2+drop}, ${x2} ${y2}`);
                });
            }

            reset() {
                this.wires.forEach(w => w.el.remove());
                this.wires = [];
                this.isPowerOn = false;
                this.switchClosed = false;
                document.getElementById('main-breaker').classList.remove('on');
                document.getElementById('visual-switch').classList.remove('active');
                document.getElementById('bulb').classList.remove('on');
                this.showAlert("Tablero reiniciado. Cortá la corriente antes de empezar.");
            }

            playSound(freq, type, vol) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            }
        }

        const game = new ElectricalGame();
        window.addEventListener('resize', () => game.updateWireVisuals());

    </script>
</body>
</html>
