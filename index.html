<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Taller Eléctrico: Validación Estricta</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-bg: #ffffff;
            /* Colores Norma IEC/Argentina */
            --wire-phase: #8B4513;   /* Marrón (Fase) */
            --wire-neutral: #3498db; /* Celeste (Neutro) */
            --wire-earth: #2ecc71;   /* Verde/Amarillo (Tierra) */
            --wire-return: #2c3e50;  /* Negro (Retorno) */
            
            --terminal-size: 18px;
            --shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: var(--bg-color);
            margin: 0; overflow: hidden; touch-action: none;
            display: flex; flex-direction: column; height: 100vh; user-select: none;
        }

        /* HEADER */
        header {
            background: #2c3e50; color: white; padding: 10px 20px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow); z-index: 10;
        }
        .tool-panel { display: flex; gap: 15px; align-items: center; }
        .status-badge { 
            background: #e74c3c; padding: 5px 12px; border-radius: 4px; 
            font-weight: bold; font-size: 0.9rem; text-transform: uppercase;
        }

        /* TABLERO JUEGO */
        #game-board {
            position: relative; flex-grow: 1;
            background-image: 
                linear-gradient(#d1d8e0 1px, transparent 1px),
                linear-gradient(90deg, #d1d8e0 1px, transparent 1px);
            background-size: 20px 20px;
            cursor: default;
        }

        #game-board.tester-mode { cursor: help; }

        #wire-layer { position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        /* COMPONENTES */
        .component {
            position: absolute; background: white; border: 2px solid #7f8c8d; border-radius: 6px;
            box-shadow: var(--shadow); z-index: 2; display: flex; flex-direction: column; align-items: center;
        }
        
        /* CAJA TÉRMICA */
        .comp-main-panel { 
            width: 120px; height: 160px; background: #34495e; color: white; 
            border: 3px solid #2c3e50; left: 5%; top: 20%;
        }
        .breaker-handle {
            width: 60px; height: 40px; background: #e74c3c; margin: 10px; border-radius: 4px;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: bold; box-shadow: inset 0 -4px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .breaker-handle.on { background: #27ae60; transform: translateY(2px); box-shadow: inset 0 2px rgba(0,0,0,0.2); }
        .breaker-handle::after { content: 'OFF'; }
        .breaker-handle.on::after { content: 'ON'; }

        /* INTERRUPTOR */
        .comp-switch { 
            width: 80px; height: 100px; left: 40%; top: 60%;
            background: #ecf0f1;
        }
        .switch-rocker {
            width: 40px; height: 60px; background: #fff; border: 1px solid #ccc;
            cursor: pointer; margin-top: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .switch-rocker.active { border-left: 4px solid #ccc; background: #f9f9f9; }

        /* LÁMPARA */
        .comp-lamp { 
            width: 80px; height: 80px; border-radius: 50%; left: 70%; top: 30%;
            border: 4px solid #bdc3c7; display: flex; justify-content: center; align-items: center;
        }
        .bulb { width: 100%; height: 100%; background: #95a5a6; border-radius: 50%; transition: 0.3s; opacity: 0.5; }
        .bulb.on { background: #f1c40f; opacity: 1; box-shadow: 0 0 50px #f1c40f; }

        /* TERMINALES */
        .terminal {
            width: var(--terminal-size); height: var(--terminal-size);
            background: #bdc3c7; border: 2px solid #555; border-radius: 50%;
            position: absolute; cursor: crosshair; z-index: 10;
        }
        .terminal:hover { transform: scale(1.2); background: #f39c12; }
        .term-label { position: absolute; font-size: 10px; font-weight: bold; pointer-events: none; color: #333; }

        /* CABLES */
        path.wire { fill: none; stroke-width: 6; stroke-linecap: round; cursor: pointer; opacity: 0.9; }
        path.wire:hover { stroke-width: 9; opacity: 1; }
        path.wire.voltage { filter: drop-shadow(0 0 4px red); } 

        /* ALERTA */
        #alert-box {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #c0392b; color: white; padding: 15px 25px; border-radius: 30px;
            font-weight: bold; opacity: 0; transition: opacity 0.3s; pointer-events: none; text-align: center; z-index: 100; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .info-card {
            position: absolute; top: 70px; right: 20px; width: 250px;
            background: rgba(255,255,255,0.9); padding: 15px; border-radius: 8px;
            border-left: 5px solid #3498db; font-size: 0.85rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .wire-legend { display: flex; align-items: center; gap: 5px; margin: 2px 0; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

    </style>
</head>
<body>

    <header>
        <div>
            <h1 style="margin:0; font-size:1.2rem;">Taller de Electricidad ⚡</h1>
            <small>Instalación: Lámpara con Retorno y Neutro</small>
        </div>
        <div class="tool-panel">
            <div id="tester-indicator" class="status-badge" style="background:#7f8c8d;">BUSCAPOLO: OFF</div>
            <button onclick="game.reset()" style="padding:5px 15px; cursor:pointer;">Reiniciar</button>
        </div>
    </header>

    <div id="game-board">
        <svg id="wire-layer"></svg>

        <div class="info-card">
            <h4>Referencia</h4>
            <div class="wire-legend"><div class="dot" style="background:#8B4513"></div> Fase (Marrón/Rojo)</div>
            <div class="wire-legend"><div class="dot" style="background:#3498db"></div> Neutro (Celeste)</div>
            <div class="wire-legend"><div class="dot" style="background:#2c3e50"></div> Retorno (Negro)</div>
            <hr>
            <strong>Requisito:</strong> La lámpara debe tener NEUTRO y RETORNO.
        </div>

        <!-- 1. TABLERO GENERAL -->
        <div class="component comp-main-panel">
            <div style="text-align:center; padding:5px; font-weight:bold;">TÉRMICA</div>
            <div id="main-breaker" class="breaker-handle" onclick="game.togglePower()"></div>
            
            <div style="position:relative; height:100px;">
                <span class="term-label" style="top:12px; right:25px; color:white;">Fase</span>
                <div class="terminal" id="t-source-phase" style="top:10px; right:-10px; background:#8B4513;"></div>
                
                <span class="term-label" style="top:42px; right:25px; color:white;">Neutro</span>
                <div class="terminal" id="t-source-neutral" style="top:40px; right:-10px; background:#3498db;"></div>
                
                <span class="term-label" style="top:72px; right:25px; color:white;">Tierra</span>
                <div class="terminal" id="t-source-earth" style="top:70px; right:-10px; background:#2ecc71;"></div>
            </div>
        </div>

        <!-- 2. INTERRUPTOR -->
        <div class="component comp-switch">
            <div style="margin-top:5px; font-weight:bold; font-size:12px;">TECLA</div>
            <div class="terminal" id="t-sw-in" style="top:30px; left:-10px;"></div>
            <span class="term-label" style="top:32px; left:12px;">L (Entrada)</span>
            
            <div class="terminal" id="t-sw-out" style="top:70px; right:-10px;"></div>
            <span class="term-label" style="top:72px; right:12px;">1 (Retorno)</span>
            <div class="switch-rocker" id="visual-switch" onclick="game.pressSwitch()"></div>
        </div>

        <!-- 3. LÁMPARA -->
        <div class="component comp-lamp">
            <div class="bulb" id="bulb"></div>
            <!-- Entrada RETORNO -->
            <div class="terminal" id="t-lamp-L" style="bottom:-10px; left:10px;"></div>
            <span class="term-label" style="bottom:15px; left:15px; font-size:9px;">Retorno</span>
            
            <!-- Entrada NEUTRO -->
            <div class="terminal" id="t-lamp-N" style="bottom:-10px; right:10px;"></div>
            <span class="term-label" style="bottom:15px; right:15px; font-size:9px;">Neutro</span>

            <div class="terminal" id="t-lamp-E" style="top:-10px; left:30px; background:#2ecc71;"></div>
            <span class="term-label" style="top:10px; left:25px; font-size:8px;">Tierra</span>
        </div>

        <div id="alert-box"></div>
    </div>

    <script>
        const svgNS = "http://www.w3.org/2000/svg";

        class ElectricalGame {
            constructor() {
                this.wires = [];
                this.isPowerOn = false;
                this.switchClosed = false;
                this.svg = document.getElementById('wire-layer');
                this.dragState = null;
                this.initInteraction();
                this.showAlert("Conectá: Fase a Tecla, Retorno a Lámpara y Neutro a Lámpara.");
            }

            // --- VALIDACIÓN ESTRICTA AL INTENTAR DAR LUZ ---
            togglePower() {
                // Si la luz ya estaba prendida, apagar simplemente
                if (this.isPowerOn) {
                    this.setPowerState(false);
                    return;
                }

                // SI ESTÁ APAGADA Y QUEREMOS PRENDER, VALIDAMOS PRIMERO
                
                // Construir mapa de conexiones actual
                const adj = this.buildAdjacencyMap();
                const isConnected = (a, b) => this.checkPath(adj, a, b);

                // 1. VERIFICAR NEUTRO EN TECLA (ERROR GRAVE)
                if (isConnected('t-source-neutral', 't-sw-in') || isConnected('t-source-neutral', 't-sw-out')) {
                    this.triggerError("❌ ERROR GRAVE: Neutro conectado a la tecla.");
                    return; // No sube la térmica
                }

                // 2. VERIFICAR NEUTRO EN LÁMPARA
                // Debe haber continuidad desde la Fuente de Neutro hasta el borne Neutro de la lámpara
                const lampHasNeutral = isConnected('t-source-neutral', 't-lamp-N');
                
                if (!lampHasNeutral) {
                    this.triggerError("❌ MALA CONEXIÓN: La lámpara no tiene Neutro.");
                    return; // No sube la térmica
                }

                // 3. VERIFICAR RETORNO EN LÁMPARA
                // Debe haber conexión desde la Salida de la Tecla (1) hasta la Entrada de la Lámpara (Retorno)
                const lampHasReturn = isConnected('t-sw-out', 't-lamp-L');

                if (!lampHasReturn) {
                    // Verificar si cometió el error de conectar Fase directa
                    if (isConnected('t-source-phase', 't-lamp-L')) {
                        this.triggerError("❌ MALA CONEXIÓN: Lámpara directa a fase. Debe usar el Retorno.");
                    } else {
                        this.triggerError("❌ MALA CONEXIÓN: Falta cable de Retorno (Tecla -> Lámpara).");
                    }
                    return; // No sube la térmica
                }

                // Si todo está bien, permitimos subir la térmica
                this.setPowerState(true);
            }

            setPowerState(isOn) {
                this.isPowerOn = isOn;
                const handle = document.getElementById('main-breaker');
                const tester = document.getElementById('tester-indicator');
                
                if (isOn) {
                    handle.classList.add('on');
                    tester.style.background = "#e67e22";
                    tester.textContent = "BUSCAPOLO: ACTIVO";
                    this.showAlert("✅ Conexión Correcta. Energía Activada.");
                } else {
                    handle.classList.remove('on');
                    tester.style.background = "#7f8c8d";
                    tester.textContent = "BUSCAPOLO: OFF";
                    this.showAlert("Corriente cortada.");
                }
                this.updateLampState();
            }

            pressSwitch() {
                this.switchClosed = !this.switchClosed;
                document.getElementById('visual-switch').classList.toggle('active');
                this.playSound(300, 'square', 0.05);
                this.updateLampState();
            }

            // --- LÓGICA DE ENCENDIDO DE LÁMPARA ---
            updateLampState() {
                const bulb = document.getElementById('bulb');
                bulb.classList.remove('on');
                this.wires.forEach(w => w.el.classList.remove('voltage'));

                if (!this.isPowerOn) return;

                // Ya sabemos que el cableado es correcto porque togglePower lo validó.
                // Ahora solo chequeamos si la tecla deja pasar corriente (Fase -> Tecla -> Retorno).
                
                const adj = this.buildAdjacencyMap();
                const hasPhaseAtSwitch = this.checkPath(adj, 't-source-phase', 't-sw-in');

                // Visualizar Tensión en cables
                this.wires.forEach(w => {
                    // Fase siempre tiene tensión
                    if (this.checkPath(adj, 't-source-phase', w.u) || this.checkPath(adj, 't-source-phase', w.v)) {
                        w.el.classList.add('voltage');
                    }
                    // Retorno tiene tensión solo si tecla cerrada
                    if (this.switchClosed && hasPhaseAtSwitch) {
                         if (w.u === 't-sw-out' || w.v === 't-sw-out') w.el.classList.add('voltage');
                    }
                });

                if (this.switchClosed && hasPhaseAtSwitch) {
                    bulb.classList.add('on');
                }
            }

            // --- UTILS GRAFOS ---
            buildAdjacencyMap() {
                const adj = {};
                this.wires.forEach(w => {
                    if(!adj[w.u]) adj[w.u]=[]; if(!adj[w.v]) adj[w.v]=[];
                    adj[w.u].push(w.v); adj[w.v].push(w.u);
                });
                return adj;
            }

            checkPath(adj, start, target) {
                if (!adj[start]) return false;
                let q = [start], visited = new Set([start]);
                while (q.length) {
                    let curr = q.shift();
                    if (curr === target) return true;
                    if (adj[curr]) {
                        for (let n of adj[curr]) {
                            if (!visited.has(n)) { visited.add(n); q.push(n); }
                        }
                    }
                }
                return false;
            }

            // --- INTERACCIÓN ---
            initInteraction() {
                document.querySelectorAll('.terminal').forEach(t => {
                    t.addEventListener('pointerdown', (e) => this.startDrag(e));
                });
                document.addEventListener('pointermove', (e) => this.drag(e));
                document.addEventListener('pointerup', (e) => this.endDrag(e));
            }

            startDrag(e) {
                if (this.isPowerOn) {
                    this.triggerError("¡PELIGRO! Cortá la térmica antes de conectar cables.");
                    return;
                }
                const t = e.target;
                this.dragState = { startId: t.id, startEl: t, path: this.createTempPath() };
                
                // Colores automáticos
                let color = '#555';
                if (t.id === 't-source-phase') color = 'var(--wire-phase)';
                else if (t.id === 't-source-neutral') color = 'var(--wire-neutral)';
                else if (t.id === 't-source-earth') color = 'var(--wire-earth)';
                else if (t.id === 't-sw-out') color = 'var(--wire-return)'; // Retorno automático
                else if (t.id === 't-lamp-N') color = 'var(--wire-neutral)'; // Si sale del neutro lámpara
                
                this.dragState.path.setAttribute('stroke', color);
            }

            drag(e) {
                if (!this.dragState) return;
                const rect = document.getElementById('game-board').getBoundingClientRect();
                const start = this.dragState.startEl.getBoundingClientRect();
                const x1 = start.left + start.width/2 - rect.left;
                const y1 = start.top + start.height/2 - rect.top;
                const x2 = e.clientX - rect.left;
                const y2 = e.clientY - rect.top;
                this.dragState.path.setAttribute('d', `M ${x1} ${y1} L ${x2} ${y2}`);
            }

            endDrag(e) {
                if (!this.dragState) return;
                this.dragState.path.remove();
                const end = document.elementFromPoint(e.clientX, e.clientY);
                if (end && end.classList.contains('terminal') && end.id !== this.dragState.startId) {
                    this.connectWires(this.dragState.startId, end.id, this.dragState.path.getAttribute('stroke'));
                }
                this.dragState = null;
            }

            connectWires(u, v, color) {
                if (this.wires.some(w => (w.u === u && w.v === v) || (w.u === v && w.v === u))) return;
                const path = document.createElementNS(svgNS, "path");
                path.classList.add('wire');
                path.setAttribute('stroke', color);
                
                const wire = { u, v, el: path };
                path.addEventListener('click', () => {
                    if (!this.isPowerOn && confirm("¿Quitar cable?")) {
                        path.remove();
                        this.wires = this.wires.filter(w => w !== wire);
                    } else if (this.isPowerOn) {
                        this.showAlert("Buscapolo: " + (path.classList.contains('voltage') ? "¡TENSIÓN!" : "Sin Tensión"));
                    }
                });
                
                this.svg.appendChild(path);
                this.wires.push(wire);
                this.updateWireVisuals();
                this.playSound(600, 'sine', 0.1);
            }

            updateWireVisuals() {
                const rect = document.getElementById('game-board').getBoundingClientRect();
                this.wires.forEach(w => {
                    const r1 = document.getElementById(w.u).getBoundingClientRect();
                    const r2 = document.getElementById(w.v).getBoundingClientRect();
                    const x1 = r1.left + r1.width/2 - rect.left;
                    const y1 = r1.top + r1.height/2 - rect.top;
                    const x2 = r2.left + r2.width/2 - rect.left;
                    const y2 = r2.top + r2.height/2 - rect.top;
                    const drop = Math.abs(x2 - x1) * 0.2 + 30;
                    w.el.setAttribute('d', `M ${x1} ${y1} C ${x1} ${y1+drop}, ${x2} ${y2+drop}, ${x2} ${y2}`);
                });
            }

            createTempPath() {
                const p = document.createElementNS(svgNS, "path");
                p.setAttribute('fill','none'); p.setAttribute('stroke-width','4'); p.setAttribute('stroke-dasharray','5,5');
                this.svg.appendChild(p); return p;
            }

            triggerError(msg) {
                const box = document.getElementById('alert-box');
                box.style.background = "#c0392b";
                box.textContent = msg;
                box.style.opacity = 1;
                this.playSound(100, 'sawtooth', 0.8);
                setTimeout(() => box.style.opacity = 0, 4000);
            }

            showAlert(msg) {
                const box = document.getElementById('alert-box');
                box.style.background = "#27ae60";
                box.textContent = msg;
                box.style.opacity = 1;
                setTimeout(() => box.style.opacity = 0, 3000);
            }

            reset() {
                this.wires.forEach(w => w.el.remove());
                this.wires = [];
                this.setPowerState(false);
                this.switchClosed = false;
                document.getElementById('visual-switch').classList.remove('active');
                document.getElementById('bulb').classList.remove('on');
            }

            playSound(freq, type, vol) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain); gain.connect(ctx.destination);
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(vol, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
                osc.start(); osc.stop(ctx.currentTime + 0.3);
            }
        }

        const game = new ElectricalGame();
        window.addEventListener('resize', () => game.updateWireVisuals());

    </script>
</body>
</html>
